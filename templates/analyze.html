{% extends "base.html" %}

{% block title %}Analyze - Elder Med Manager{% endblock %}

{% block content %}
<div class="analyze-container">
    <h1><i class="fas fa-stethoscope"></i> Medication Analysis</h1>
    
    <div class="form-container">
        <div class="form-section">
            <h2><i class="fas fa-user-md"></i> Patient Information</h2>
            
            <div class="form-group">
                <label for="age">Patient Age *</label>
                <input type="number" id="age" name="age" min="65" max="120" value="75" required>
                <small>Must be 65 or older for accurate assessment</small>
            </div>
            
            <div class="checkbox-group">
                <label>
                    <input type="checkbox" id="cognitive_impairment">
                    <span>Patient has cognitive impairment (dementia, MCI)</span>
                </label>
                <label>
                    <input type="checkbox" id="caregiver_present">
                    <span>Caregiver manages medications</span>
                </label>
            </div>

            <!-- Add this in analyze.html AFTER the checkbox-group div -->
<!-- Around line 32, after the caregiver_present checkbox -->

            <div class="timing-preferences">
                <h4>
                    <i class="fas fa-clock"></i> 
                    Medication Timing Preferences
                </h4>
                <p style="color: #7a7a7a; font-size: 0.9rem; margin-bottom: 1rem;">
                    Customize when medications are typically taken. This will personalize the daily schedule.
                </p>
                
                <div class="timing-grid">
                    <div class="timing-slot">
                        <label>
                            <span class="timing-icon morning">‚òÄÔ∏è</span>
                            Morning
                        </label>
                        <input type="time" id="morning-time" value="08:00">
                    </div>
                    
                    <div class="timing-slot">
                        <label>
                            <span class="timing-icon noon">üå§Ô∏è</span>
                            Midday
                        </label>
                        <input type="time" id="noon-time" value="12:00">
                    </div>
                    
                    <div class="timing-slot">
                        <label>
                            <span class="timing-icon evening">üåÖ</span>
                            Evening
                        </label>
                        <input type="time" id="evening-time" value="18:00">
                    </div>
                    
                    <div class="timing-slot">
                        <label>
                            <span class="timing-icon bedtime">üåô</span>
                            Bedtime
                        </label>
                        <input type="time" id="bedtime-time" value="22:00">
                    </div>
                </div>
                
                <button type="button" class="btn-reset-times" onclick="resetTimingDefaults()">
                    <i class="fas fa-undo"></i> Reset to Defaults
                </button>
                
                <div class="timing-note">
                    <i class="fas fa-info-circle"></i>
                    <strong>Tip:</strong> Set times based on patient's actual daily routine for more accurate adherence predictions.
                </div>
            </div>
        </div>
        
        <div class="form-section">
            <h2><i class="fas fa-prescription-bottle-alt"></i> Medications</h2>
            <p class="help-text">
                <i class="fas fa-info-circle"></i> 
                <strong>Real-time checking enabled!</strong> Warnings appear as you enter medications.
            </p>
            <p class="help-text">Include ALL medications: prescriptions, OTC, vitamins, supplements</p>
            
            <div id="medications-container">
                <div class="medication-row" data-id="1">
                    <div class="med-input">
                        <label>Medication Name</label>
                        <input type="text" 
                            name="medication_name_1"
                            class="med-name" 
                            placeholder="e.g., Lisinopril, Tylenol, Vitamin D" 
                            required
                            autocomplete="off">
                    </div>
                    <div class="med-input">
                        <label>Times Per Day</label>
                        <input type="number" 
                               name="doses_per_day_1"
                               class="med-frequency" 
                               min="1" 
                               max="6" 
                               value="1" 
                               required>
                    </div>
                    <button type="button" class="btn-remove-med" onclick="removeMedication(1)">
                        <i class="fas fa-times"></i>
                    </button>
                    <!-- Warning container will be added here automatically by JavaScript -->
                </div>
            </div>
            
            <button type="button" class="btn btn-secondary" onclick="addMedication()">
                <i class="fas fa-plus"></i> Add Medication
            </button>
            
            <div class="med-tips">
                <p><strong>Tips:</strong></p>
                <ul>
                    <li>üîç Warnings appear automatically as you type</li>
                    <li>üíä Enter brand or generic names</li>
                    <li>üè• Include supplements like calcium, vitamins</li>
                    <li>üí§ Include OTC pain relievers, sleep aids</li>
                    <li>üëÅÔ∏è Don't forget eye drops, inhalers, patches</li>
                </ul>
            </div>
        </div>
        
        <div class="form-actions">
            <button type="button" class="btn btn-primary" onclick="analyzeMedications()">
                <i class="fas fa-chart-bar"></i> Analyze Medication Burden
            </button>
        </div>
    </div>
    
    <!-- Results will be displayed here -->
    <div id="results-container" style="display: none;">
        <div class="results-header">
            <h2><i class="fas fa-file-medical-alt"></i> Analysis Results</h2>
            <div class="result-actions">
                <button class="btn btn-outline" onclick="exportPDF()">
                    <i class="fas fa-file-pdf"></i> PDF Report
                </button>
                <button class="btn btn-outline" onclick="exportCSV()">
                    <i class="fas fa-file-csv"></i> CSV Export
                </button>
            </div>
        </div>
        
        <div id="results-content">
            <!-- Results will be loaded here via JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Add autocomplete script FIRST -->
<script src="{{ url_for('static', filename='js/autocomplete.js') }}"></script>
<script src="{{ url_for('static', filename='js/med-checker.js') }}"></script>

<script>
let medicationCount = 1;

// ADD these helper functions at the TOP of your <script> section in analyze.html
// Add right after: let medicationCount = 1;

/**
 * Get custom medication timing preferences
 */
function getCustomTimes() {
    return {
        morning: document.getElementById('morning-time').value,
        noon: document.getElementById('noon-time').value,
        evening: document.getElementById('evening-time').value,
        bedtime: document.getElementById('bedtime-time').value
    };
}

/**
 * Reset timing to defaults
 */
function resetTimingDefaults() {
    document.getElementById('morning-time').value = '08:00';
    document.getElementById('noon-time').value = '12:00';
    document.getElementById('evening-time').value = '18:00';
    document.getElementById('bedtime-time').value = '22:00';
}

/**
 * Validate timing preferences (ensure logical order)
 */
function validateTimes() {
    const times = getCustomTimes();
    const timeValues = [
        times.morning,
        times.noon,
        times.evening,
        times.bedtime
    ];
    
    // Check if times are in order
    for (let i = 0; i < timeValues.length - 1; i++) {
        if (timeValues[i] >= timeValues[i + 1]) {
            alert('‚ö†Ô∏è Medication times should be in order (morning ‚Üí noon ‚Üí evening ‚Üí bedtime)');
            return false;
        }
    }
    
    return true;
}

// THEN UPDATE your existing analyzeMedications() function:
// Find the line: const patientInfo = { ... }
// And REPLACE it with this:

async function analyzeMedications() {
    // Validate timing preferences first
    if (!validateTimes()) {
        return;
    }
    
    // Collect data
    const patientInfo = {
        age: parseInt(document.getElementById('age').value),
        cognitive_impairment: document.getElementById('cognitive_impairment').checked,
        caregiver_present: document.getElementById('caregiver_present').checked,
        custom_times: getCustomTimes()  // <-- ADD THIS LINE
    };
    
    const medications = [];
    const rows = document.querySelectorAll('.medication-row');
    rows.forEach(row => {
        const name = row.querySelector('.med-name').value.trim();
        const freq = parseInt(row.querySelector('.med-frequency').value);
        if (name) {
            medications.push({
                name: name,
                doses_per_day: freq
            });
        }
    });
    
    if (medications.length === 0) {
        alert('Please add at least one medication');
        return;
    }
    
    // Show loading
    document.getElementById('results-container').style.display = 'block';
    document.getElementById('results-content').innerHTML = `
        <div class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Analyzing medications with your custom schedule...</p>
        </div>
    `;
    
    // Scroll to results
    document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
    
    try {
        const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                age: patientInfo.age,
                cognitive_impairment: patientInfo.cognitive_impairment,
                caregiver_present: patientInfo.caregiver_present,
                custom_times: patientInfo.custom_times,  // <-- ADD THIS LINE
                medications: medications
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayResults(data.report);
        } else {
            document.getElementById('results-content').innerHTML = `
                <div class="error">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>Analysis Error</h3>
                    <p>${data.error || 'Unknown error occurred'}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Analysis error:', error);
        document.getElementById('results-content').innerHTML = `
            <div class="error">
                <i class="fas fa-exclamation-circle"></i>
                <h3>Connection Error</h3>
                <p>Unable to connect to server. Please try again.</p>
                <p class="error-details">${error.message}</p>
            </div>
        `;
    }
}

// REST OF YOUR EXISTING CODE STAYS THE SAME

function addMedication() {
    medicationCount++;
    const container = document.getElementById('medications-container');
    const newRow = document.createElement('div');
    newRow.className = 'medication-row';
    newRow.setAttribute('data-id', medicationCount);
    newRow.innerHTML = `
        <div class="med-input">
            <label>Medication Name</label>
            <input type="text" 
                   name="medication_name_${medicationCount}"
                   class="med-name" 
                   placeholder="e.g., Lisinopril, Tylenol, Vitamin D" 
                   required
                   autocomplete="off">
        </div>
        <div class="med-input">
            <label>Times Per Day</label>
            <input type="number" 
                   name="doses_per_day_${medicationCount}"
                   class="med-frequency" 
                   min="1" 
                   max="6" 
                   value="1" 
                   required>
        </div>
        <button type="button" class="btn-remove-med" onclick="removeMedication(${medicationCount})">
            <i class="fas fa-times"></i>
        </button>
    `;
    container.appendChild(newRow);
    
    // Initialize autocomplete for new input
    if (window.DrugAutocomplete) {
        new DrugAutocomplete(newRow.querySelector('.med-name'));
    }
    
    // Reinitialize checker
    if (window.MedChecker) {
        window.MedChecker.reinitialize();
    }
}

function removeMedication(id) {
    const row = document.querySelector(`[data-id="${id}"]`);
    if (row && medicationCount > 1) {
        row.remove();
        
        if (window.MedChecker) {
            window.MedChecker.reinitialize();
        }
    }
}

async function analyzeMedications() {
    // Collect data
    const patientInfo = {
        age: parseInt(document.getElementById('age').value),
        cognitive_impairment: document.getElementById('cognitive_impairment').checked,
        caregiver_present: document.getElementById('caregiver_present').checked
    };
    
    const medications = [];
    const rows = document.querySelectorAll('.medication-row');
    rows.forEach(row => {
        const name = row.querySelector('.med-name').value.trim();
        const freq = parseInt(row.querySelector('.med-frequency').value);
        if (name) {
            medications.push({
                name: name,
                doses_per_day: freq
            });
        }
    });
    
    if (medications.length === 0) {
        alert('Please add at least one medication');
        return;
    }
    
    // Show loading
    document.getElementById('results-container').style.display = 'block';
    document.getElementById('results-content').innerHTML = `
        <div class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Analyzing medications... This may take a moment.</p>
        </div>
    `;
    
    // Scroll to results
    document.getElementById('results-container').scrollIntoView({ behavior: 'smooth' });
    
    try {
        const response = await fetch('/api/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                age: patientInfo.age,
                cognitive_impairment: patientInfo.cognitive_impairment,
                caregiver_present: patientInfo.caregiver_present,
                medications: medications
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayResults(data.report);
        } else {
            document.getElementById('results-content').innerHTML = `
                <div class="error">
                    <i class="fas fa-exclamation-circle"></i>
                    <h3>Analysis Error</h3>
                    <p>${data.error || 'Unknown error occurred'}</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Analysis error:', error);
        document.getElementById('results-content').innerHTML = `
            <div class="error">
                <i class="fas fa-exclamation-circle"></i>
                <h3>Connection Error</h3>
                <p>Unable to connect to server. Please try again.</p>
                <p class="error-details">${error.message}</p>
            </div>
        `;
    }
}

function displayResults(report) {
    // Determine severity classes for styling
    const pillBurdenClass = report.total_pills >= 15 ? 'high' : 
                            report.total_pills >= 10 ? 'medium' : 'low';
    
    const fallRiskClass = report.fall_risk_category === 'HIGH' ? 'high' : 
                          report.fall_risk_category === 'MODERATE' ? 'medium' : 'low';
    
    const adherenceClass = report.adherence_prediction < 60 ? 'high' : 
                           report.adherence_prediction < 80 ? 'medium' : 'low';
    
    let html = `
        <div class="result-summary">
            <h3><i class="fas fa-chart-pie"></i> Summary Metrics</h3>
            <div class="summary-cards">
                <div class="summary-card ${pillBurdenClass}">
                    <h4>üíä Pill Burden</h4>
                    <p class="value">${report.total_pills} pills/day</p>
                    <p class="label">${report.total_meds} medications</p>
                    <p class="sublabel">${report.pill_burden_level}</p>
                </div>
                
                <div class="summary-card ${adherenceClass}">
                    <h4>üìä Predicted Adherence</h4>
                    <p class="value">${report.adherence_prediction}%</p>
                    <p class="label">${report.memory_actions} times/day to remember</p>
                </div>
                
                <div class="summary-card ${fallRiskClass}">
                    <h4>‚ö†Ô∏è Fall Risk</h4>
                    <p class="value">${report.fall_risk_score}/10</p>
                    <p class="label">${report.fall_risk_category}</p>
                </div>
                
                <div class="summary-card ${report.beers_violations.length > 0 ? 'high' : 'low'}">
                    <h4>üö® Beers Criteria</h4>
                    <p class="value">${report.beers_violations.length}</p>
                    <p class="label">Inappropriate meds</p>
                </div>
            </div>
        </div>
    `;
    
    // Beers Criteria Violations
    if (report.beers_violations && report.beers_violations.length > 0) {
        html += `
            <div class="result-section alert-high">
                <h3><i class="fas fa-exclamation-triangle"></i> Beers Criteria Violations</h3>
                <p class="section-intro">These medications are potentially inappropriate for elderly patients:</p>
                <div class="violations-list">
        `;
        
        report.beers_violations.forEach(violation => {
            html += `
                <div class="violation-card">
                    <h4>‚ùå ${violation.drug}</h4>
                    <p><strong>Category:</strong> ${violation.details.category}</p>
                    <p><strong>Risk Level:</strong> <span class="badge-${violation.details.risk}">${violation.details.risk.toUpperCase()}</span></p>
                    <p><strong>Why Inappropriate:</strong> ${violation.details.rationale}</p>
                    <p><strong>Recommendation:</strong> ${violation.details.recommendation}</p>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // Drug Interactions
    if (report.dir_triggers && report.dir_triggers.length > 0) {
        html += `
            <div class="result-section alert-moderate">
                <h3><i class="fas fa-exchange-alt"></i> Drug Interactions (${report.dir_triggers.length})</h3>
                <div class="interactions-list">
        `;
        
        report.dir_triggers.forEach(([drug1, drug2, severity]) => {
            html += `
                <div class="interaction-card severity-${severity}">
                    <h4>${drug1} + ${drug2}</h4>
                    <span class="badge-${severity}">${severity.toUpperCase()}</span>
                </div>
            `;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // Daily Schedule
    if (report.schedule) {
        html += `
            <div class="result-section">
                <h3><i class="fas fa-calendar-day"></i> Daily Medication Schedule</h3>
                <div class="schedule-timeline">
        `;
        
        for (const [time, meds] of Object.entries(report.schedule)) {
            const medCount = meds.length;
            const hasMany = medCount > 3;
            
            html += `
                <div class="schedule-slot ${medCount > 0 ? 'has-meds' : ''} ${hasMany ? 'many-meds' : ''}">
                    <div class="schedule-time">${time}</div>
                    <div class="schedule-meds">
            `;
            
            if (medCount > 0) {
                html += `<div class="med-count-badge">${medCount} med${medCount > 1 ? 's' : ''}</div>`;
                meds.forEach(med => {
                    html += `<div class="med-pill">üíä ${med}</div>`;
                });
            } else {
                html += `<div class="no-meds">-</div>`;
            }
            
            html += `
                    </div>
                </div>
            `;
        }
        
        html += `
                </div>
                <p class="schedule-note">üí° <strong>Tip:</strong> Use a pill organizer to prepare medications weekly</p>
            </div>
        `;
    }
    
    // Simplification Recommendations
    if (report.simplification_recs && report.simplification_recs.length > 0) {
        html += `
            <div class="result-section">
                <h3><i class="fas fa-lightbulb"></i> Simplification Recommendations</h3>
                <div class="recommendations-list">
        `;
        
        report.simplification_recs.forEach(rec => {
            html += `<div class="recommendation-item">${rec}</div>`;
        });
        
        html += `
                </div>
            </div>
        `;
    }
    
    // Scores
    html += `
        <div class="result-section">
            <h3><i class="fas fa-calculator"></i> Assessment Scores</h3>
            <div class="scores-grid">
                <div class="score-card">
                    <h4>MCLS (Medication Cognitive Load)</h4>
                    <p class="score-value">${report.mcls_score}</p>
                    <p class="score-label">${report.mcls_burden}</p>
                    <p class="score-explanation">${report.mcls_explanation}</p>
                </div>
                
                <div class="score-card">
                    <h4>DIRS (Drug Interaction Risk)</h4>
                    <p class="score-value">${report.dir_score}</p>
                    <p class="score-label">${report.dir_risk}</p>
                </div>
                
                <div class="score-card">
                    <h4>Anticholinergic Burden</h4>
                    <p class="score-value">${report.anticholinergic_score}</p>
                    <p class="score-label">${
                        report.anticholinergic_score >= 3 ? 'HIGH - Urgent review needed' :
                        report.anticholinergic_score >= 2 ? 'MODERATE - Monitor closely' :
                        report.anticholinergic_score >= 1 ? 'LOW - Minimal concern' :
                        'NONE'
                    }</p>
                </div>
            </div>
        </div>
    `;
    
    // Next Steps
    html += `
        <div class="result-section next-steps">
            <h3><i class="fas fa-tasks"></i> Recommended Next Steps</h3>
            <ol class="next-steps-list">
                <li>Share this report with patient's physician or clinical pharmacist</li>
                <li>Discuss any Beers Criteria violations and possible alternatives</li>
                <li>Implement fall prevention strategies if fall risk is elevated</li>
                <li>Consider simplification opportunities to improve adherence</li>
                <li>Set up medication organizer and/or caregiver support if needed</li>
                <li>Monitor for side effects, especially confusion, dizziness, falls</li>
            </ol>
            <div class="disclaimer-box">
                <p><strong>‚ö†Ô∏è Important:</strong> This is an educational assessment tool. Do NOT stop or change medications without consulting healthcare professionals.</p>
            </div>
        </div>
    `;
    
    document.getElementById('results-content').innerHTML = html;
}

function exportPDF() {
    window.location.href = '/api/export/pdf';
}

function exportCSV() {
    window.location.href = '/api/export/csv';
}
</script>
{% endblock %}